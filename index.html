<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BeatsEdge</title>

<style>
body{
margin:0;
background:#000;
color:#fff;
font-family:Arial,Helvetica,sans-serif;
}

.topbar{
display:flex;
justify-content:space-between;
align-items:center;
padding:18px 30px;
background:#0b0b0b;
border-bottom:1px solid #1f1f1f;
}

.logo{
font-size:22px;
font-weight:700;
}

.controls{
padding:20px;
text-align:center;
border-bottom:1px solid #1f1f1f;
}

select{
padding:8px 14px;
background:#111;
color:#fff;
border:1px solid #333;
}

#players{
padding:30px;
max-width:1200px;
margin:auto;
}

.player-card{
background:#111;
border:1px solid #1f1f1f;
margin-bottom:20px;
border-radius:8px;
overflow:hidden;
}

.player-header{
display:flex;
justify-content:space-between;
align-items:center;
padding:18px;
cursor:pointer;
}

.player-info{
display:flex;
align-items:center;
gap:12px;
}

.avatar{
background:#1f1f1f;
width:40px;
height:40px;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
font-weight:700;
overflow:hidden;
}

.avatar img{
width:100%;
height:100%;
object-fit:cover;
}

.player-body{
display:none;
padding:20px;
border-top:1px solid #1f1f1f;
}

.player-body.open{
display:block;
}

.prop-box{
background:#1a1a1a;
padding:10px 16px;
border-radius:6px;
margin-right:10px;
display:inline-block;
}

.grade{
font-weight:700;
font-size:18px;
}

.empty{
text-align:center;
padding:60px;
color:#888;
}
</style>
</head>

<body>

<div class="topbar">
<div class="logo">BeatsEdge</div>
</div>

<div class="controls">
<select onchange="changeSort(this.value)">
  <option value="edge">Sort by Edge</option>
  <option value="prob">Sort by Probability</option>
  <option value="name">Sort by Name</option>
</select>
</div>

<div id="players"></div>

<script>

let globalData = [];

/* ===========================
   LOAD DATA
=========================== */

async function loadData(){
  try{
    const res = await fetch('/api/edges/today');
    const data = await res.json();
    globalData = data.players || [];
    renderPlayers();
  }catch(e){
    console.error("API error:",e);
  }
}

/* ===========================
   GRADING SYSTEM
=========================== */

function getGrade(edge){
  if(edge >= 15) return {grade:"A+", color:"#1db954"};
  if(edge >= 12) return {grade:"A", color:"#2ecc71"};
  if(edge >= 8)  return {grade:"B", color:"#f1c40f"};
  if(edge >= 4)  return {grade:"C", color:"#e67e22"};
  return {grade:"D", color:"#e74c3c"};
}

/* ===========================
   SORTING
=========================== */

function changeSort(type){

  if(!globalData.length) return;

  if(type === "edge"){
    globalData.sort((a,b)=> b.props[0].edge - a.props[0].edge);
  }

  if(type === "prob"){
    globalData.sort((a,b)=> b.props[0].probability - a.props[0].probability);
  }

  if(type === "name"){
    globalData.sort((a,b)=> a.player.localeCompare(b.player));
  }

  renderPlayers();
}

/* ===========================
   RENDER
=========================== */

function renderPlayers(){

  const container = document.getElementById("players");

  if(!globalData.length){
    container.innerHTML = `
      <div class="empty">
        <h2>No Active NBA Slate</h2>
        <p>Waiting for projections...</p>
      </div>
    `;
    return;
  }

  let html = "";

  globalData.forEach((p,i)=>{

    const first = p.props[0];
    const g = getGrade(first.edge || 0);

    html += `
    <div class="player-card">

      <div class="player-header" onclick="toggle(${i})">
        <div class="player-info">

          <div class="avatar">
            ${p.playerId
              ? `<img src="https://a.espncdn.com/i/headshots/nba/players/full/${p.playerId}.png"
                 onerror="this.remove(); this.parentNode.innerHTML='${p.player.split(" ").map(x=>x[0]).join("")}'">`
              : p.player.split(" ").map(x=>x[0]).join("")
            }
          </div>

          <div>
            <strong>${p.player}</strong>
            <div style="color:#888;font-size:13px;margin-top:4px;">
              ${p.team || ""}
            </div>
          </div>

        </div>

        <div style="text-align:right;">
          <div class="grade" style="color:${g.color}">
            ${g.grade}
          </div>
          <div style="font-size:13px;color:#aaa;">
            ${first.probability}%
          </div>
        </div>

      </div>

      <div class="player-body" id="body-${i}">
        ${p.props.map(prop=>`
          <div class="prop-box">
            <div><strong>${prop.stat}</strong></div>
            <div>Line: ${prop.line}</div>
            <div>Edge: ${prop.edge}%</div>
          </div>
        `).join("")}
      </div>

    </div>
    `;
  });

  container.innerHTML = html;
}

/* ===========================
   TOGGLE
=========================== */

function toggle(i){
  document.getElementById("body-"+i).classList.toggle("open");
}

loadData();

</script>

</body>
</html>
