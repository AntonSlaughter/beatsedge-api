<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>BeatsEdge</title>

<style>
body{
margin:0;
background:#000;
color:#fff;
font-family:Arial,Helvetica,sans-serif;
}

.topbar{
display:flex;
justify-content:space-between;
align-items:center;
padding:18px 30px;
background:#0b0b0b;
border-bottom:1px solid #1f1f1f;
}

.logo{
font-size:22px;
font-weight:700;
}

#players{
padding:30px;
max-width:1300px;
margin:auto;
}

.player-card{
background:#111;
border:1px solid #1f1f1f;
margin-bottom:20px;
border-radius:8px;
overflow:hidden;
}

.player-header{
display:flex;
justify-content:space-between;
align-items:center;
padding:18px;
cursor:pointer;
}

.player-info{
display:flex;
align-items:center;
gap:12px;
}

.avatar{
background:#1f1f1f;
width:40px;
height:40px;
border-radius:50%;
display:flex;
align-items:center;
justify-content:center;
font-weight:700;
}

.avatar img{
width:100%;
height:100%;
object-fit:cover;
border-radius:50%;
}

.team-logo{
width:26px;
height:26px;
object-fit:contain;
}

.header-left{
display:flex;
align-items:center;
gap:12px;
}

.player-body{
display:none;
padding:25px;
border-top:1px solid #1f1f1f;
}

.player-body.open{
display:block;
}

.section{
margin-bottom:40px;
}

.section-title{
font-size:13px;
color:#888;
margin-bottom:15px;
text-transform:uppercase;
letter-spacing:1px;
}

.prop-row{
display:flex;
gap:12px;
flex-wrap:wrap;
margin-bottom:20px;
}

.prop-box{
background:#1a1a1a;
padding:10px 16px;
border-radius:6px;
cursor:pointer;
border:1px solid #222;
min-width:90px;
text-align:center;
}

.prop-box.active{
background:#1db954;
color:#000;
font-weight:700;
}

/* GRAPH */

.graph-wrapper{
background:#1a1a1a;
border:1px solid #222;
border-radius:8px;
padding:20px;
position:relative;
overflow-x:auto;
}

.graph-bars{
display:flex;
align-items:flex-end;
gap:14px;
height:220px;
}

.bar-wrapper{
display:flex;
flex-direction:column;
align-items:center;
}

.bar{
width:28px;
border-radius:4px;
display:flex;
align-items:flex-start;
justify-content:center;
font-size:12px;
font-weight:600;
color:#fff;
}

.bar-label{
font-size:11px;
margin-top:6px;
color:#aaa;
}

.avg-line{
position:absolute;
left:0;
right:0;
height:2px;
background:#fff;
opacity:.4;
}

/* USAGE */

.stat-box{
background:#1a1a1a;
border:1px solid #222;
border-radius:6px;
padding:16px;
}

.stat-row{
display:flex;
justify-content:space-between;
padding:10px 0;
border-bottom:1px solid #222;
}

.stat-row:last-child{
border-bottom:none;
}

/* DEFENSE */

.def-grid{
display:grid;
grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
gap:18px;
}

.def-card{
background:#1a1a1a;
border:1px solid #222;
border-radius:6px;
padding:16px;
}

.def-title{
font-size:12px;
color:#888;
margin-bottom:10px;
}

.def-row{
display:flex;
justify-content:space-between;
margin-top:6px;
}

.def-green{color:#1db954;}
.def-yellow{color:#ffcc00;}
.def-red{color:#ff4d4d;}

.favorable{
margin-top:10px;
color:#1db954;
font-size:12px;
}

</style>
</head>

<body>

<div class="topbar">
<div class="logo">BeatsEdge</div>
</div>

<div id="players"></div>

<script>
let globalData=[];

async function loadData(){
try{
const res=await fetch('/api/edges/today');
const data=await res.json();
globalData=data.players||[];
renderPlayers();
}catch(e){
console.error("API error:",e);
}
}

function formatGameTime(iso){
  if(!iso) return "";
  const date = new Date(iso);
  return date.toLocaleTimeString([], {
    hour: 'numeric',
    minute: '2-digit'
  });
}

function defenseTier(rank){
if(rank>=20) return "green";
if(rank>=10) return "yellow";
return "red";
}

function renderPlayers(){

const container=document.getElementById("players");
if(!container) return;

let html="";

globalData.forEach((p,i)=>{

const first=p.props[0];

html+=`
<div class="player-card">

<div class="player-header" onclick="toggle(${i})">
<div class="player-info">

<div class="avatar">
${p.playerId
? `<img 
     src="https://a.espncdn.com/i/headshots/nba/players/full/${p.playerId}.png"
     onerror="this.remove(); this.parentNode.innerHTML='${p.player.split(" ").map(x=>x[0]).join("")}'">
   `
: p.player.split(" ").map(x=>x[0]).join("")
}
</div>

<div>
<div class="header-left">
<strong>${p.player}</strong>
</div>

<div style="display:flex;align-items:center;gap:8px;color:#888;font-size:13px;margin-top:4px;">
<img src="https://a.espncdn.com/i/teamlogos/nba/500/${p.team}.png"
     class="team-logo"
     onerror="this.remove()">

<span>${p.team} @ ${p.opponent}</span>

<img src="https://a.espncdn.com/i/teamlogos/nba/500/${p.opponent}.png"
     class="team-logo"
     onerror="this.remove()">

<span style="margin-left:8px;color:#aaa;">
${formatGameTime(p.startTime)}
</span>
</div>
</div>

</div>
<div>${first.probability||50}%</div>
</div>

<div class="player-body" id="body-${i}">

<div class="section">
<div class="section-title">Props</div>
<div class="prop-row">
${p.props.map((prop,j)=>`
<div class="prop-box ${j===0?'active':''}" onclick="selectProp(event,${i},${j})">
<div>${prop.stat}</div>
<div>${prop.line}</div>
</div>
`).join("")}
</div>
</div>

<div id="analytics-${i}">
${renderAnalytics(first)}
</div>

</div>
</div>
`;

});

container.innerHTML=html;
}

function renderAnalytics(prop){

let html="";

/* HEADER STATS */
html+=`
<div class="section">
<div style="display:flex;justify-content:space-between;margin-bottom:15px;">
<div><strong>Hit Rate</strong><br>${prop.probability||59}%</div>
<div><strong>Average</strong><br>${prop.average||19.8}</div>
<div><strong>Median</strong><br>${prop.median||18}</div>
<div><strong>Range</strong><br>${prop.range||"13 - 28"}</div>
<div><strong>Games</strong><br>${prop.games||17}</div>
</div>
`;

/* GRAPH */
html+=buildGraph(prop);
html+=`</div>`;

/* USAGE */
html+=`
<div class="section">
<div class="section-title">Usage & Opportunity</div>
<div class="stat-box">
${statRow("Usg Rate",prop.usage||28.5)}
${statRow("Touches",prop.touches||75.2)}
${statRow("Time Of Poss",prop.timeOfPoss||5.8)}
${statRow("FG Attempts",prop.fgAttempts||19.3)}
${statRow("FT Attempts",prop.ftAttempts||5.2)}
</div>
</div>
`;

/* DEFENSE */
html+=`
<div class="section">
<div class="section-title">Opponent Defense Stats</div>
<div class="def-grid">
${defCard("PG",prop.oppPG||mockDefense(28))}
${defCard("SG",prop.oppSG||mockDefense(25))}
${defCard("SF",prop.oppSF||mockDefense(18))}
${defCard("PF",prop.oppPF||mockDefense(15))}
${defCard("C",prop.oppC||mockDefense(12))}
</div>
</div>
`;

return html;
}

function buildGraph(prop){

let values=prop.recentGames||[23,16,16,18,15,27,20,28,24,21,27,16,13,25,14];
let avg=prop.average||19.8;
let max=Math.max(...values)+5;

let bars="";

values.forEach((val,i)=>{

let height=(val/max)*180;
let color=val>=avg?"#1db954":"#ff4d4d";

bars+=`
<div class="bar-wrapper">
<div class="bar" style="height:${height}px;background:${color};">
<span style="margin-top:-18px;">${val}</span>
</div>
<div class="bar-label">G${i+1}</div>
</div>
`;
});

let avgHeight=(avg/max)*180+20;

return `
<div class="graph-wrapper">
<div class="graph-bars">
${bars}
</div>
<div class="avg-line" style="bottom:${avgHeight}px;"></div>
</div>
`;
}

function statRow(label,val){
return `
<div class="stat-row">
<span>${label}</span>
<span>${val}%</span>
</div>
`;
}

function defCard(position,data){

const tier=defenseTier(data.rank);

return `
<div class="def-card">
<div class="def-title">${position} POSITION</div>

<div class="def-row">
<span>Points Allowed</span>
<span>${data.points} <span class="def-${tier}">#${data.rank}</span></span>
</div>

<div class="def-row">
<span>Assists Allowed</span>
<span>${data.assists}</span>
</div>

<div class="def-row">
<span>Rebounds Allowed</span>
<span>${data.rebounds}</span>
</div>

${data.rank>=20?'<div class="favorable">âœ“ Favorable Matchup</div>':''}

</div>
`;
}

function mockDefense(rank){
return{
rank:rank,
points:(15+Math.random()*10).toFixed(1),
assists:(3+Math.random()*5).toFixed(1),
rebounds:(4+Math.random()*8).toFixed(1)
};
}

function toggle(i){
document.getElementById("body-"+i).classList.toggle("open");
}

function selectProp(e,playerIndex,propIndex){
e.stopPropagation();
const body=document.getElementById("body-"+playerIndex);
body.querySelectorAll(".prop-box").forEach(b=>b.classList.remove("active"));
body.querySelectorAll(".prop-box")[propIndex].classList.add("active");

const prop=globalData[playerIndex].props[propIndex];
document.getElementById("analytics-"+playerIndex).innerHTML=renderAnalytics(prop);
}

loadData();
</script>

</body>
</html>
